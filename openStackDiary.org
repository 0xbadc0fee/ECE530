#+TITLE: OpenStack Diary
#+AUTHOR:Silas Curfman
#+DESCRIPTION: Intro to Cloud, Spring 2023b
#+TEXT: Outline and Task list for report
#+SEQ_TODO: NEXT(n) TODO(t) WAITING(w) SOMEDAY(s) | DONE(d) CANCELLED(c)
#+SETUPFILE: ~/0xbadc0fee-standard-latex-export.org
#+OPTIONS: toc:t broken-links:mark

* HW 1
Set up OpenStack, see Mod 1 rubric
* Roadmap 
1. Environment Installation
   1. Security
   2. Host Networking
   3. NTP
   4. Package Archives
   5. SQL
   6. Message Queue
   7. Memcached
   8. Etcd
2. Projects Installation
   1. Keystone
   2. Glance
   3. Placement
   4. Nova
   5. Neutron
   6. Horizon
   7. Cinder

* Envrionment Installation Journal 
** Pre-install Tests / Notes
*** TODO Trial / Test VM's [6/6]
- [X] Install a HyperVisor (VMware / esxi)
- [X] Create multiple VM's for OpenStack Components
  - [X] CPU = 6 Cores
  - [X] RAM = 6 GB
  - [X] +HDD = 200 GB+
- [X] DO NOT USE AUTODEPLOY TOOLS
- [X] Take Screenshots for steps, attach here in journal
- [X] Collect information for use in publishing as a report
- [X] Create a references section for external resources, links

*** General Notes:
+ Use Yoga Install Instructions https://docs.openstack.org/swift/yoga/install/
+ Use minimal install version of OS (Ubuntu 20.0.4)
+ Use 64bit version of OS
+ Build Ea Host as it's own VM.  Can take snapshots, rollbacks, etc.
  (note that many vm's WILL have reduced performance as number of VMs increases)

*** Hypervisor Install Notes
+ Installed on HP ProLiant MicroServer, 4 TB, 32GB Ram
+ Balance min requirements per vm host comparing Ubuntu min req's and OpenStack min Req's, if room, install each service on sep host.
+ Build template vm and then replcate for each service, make edits as needed (#of nics, # of cores, etc)
+ Per yoga install... controller node: 1 core, 4GB ram, 5GB hdd
+ per yoga install... compute node:1 core, 2gb ram, 10GB hdd
+ Ubuntu lts server... 2 core, 4gb ram, 25gb hdd
+ template build.... 2 core, 6gb ram, 40 gb hdd, 2 NIC
------
*** Home Lab Config Notes:
+ Hypervisor (HVS): HP Proliant Microserver Gen10, 4tb, 32gb ram, 4 NICS,
+ Router (RTR): pfSense Firewall / Router, 4 NICS (WAN,LAN,OPT1,OTP2),
  + WAN : ISP
  + LAN: CLASS C 192.168.1.1/24
  + OPT1: CLASS A 10.0.0.1/24 DHCP4=FALSE
  + OPT2: CLASS C 203.0.113.1/24 DHCP4=TRUE
+ Physical Network
  + RTR igb0 <-> ISP
  + HVS igb0 <-> RTR igb1
  + HVS igb1  X
  + HVS igb2 <-> RTR igb2
  + HVS igb3 <-> RTR igb3
+ Virtual Network
  + vSwitch1 = management network <-> HVS igb2
  + vSwitch2 = provider network <-> HVS igb3
-----
*** TODO Environment Install Task List / YOGA / UBUNTU (1 VM per host method)
- [X] 5.1 _Security_ (Preconfigure VM's) [5/5]
  (specs from testing above, using HP Proliant Microserver & ESXI 7.0)
  - [X] CPU = 2 cores
  - [X] RAM = 4 GB
  - [X] HDD = 40 GB
  - [X] NICs = 2x
  - [X] 5x Instances
    - [X] 'controller'
    - [X] 'compute1'
    - [X] 'block1'
    - [X] 'object1'
    - [X] 'object2'
- [ ] _SNAPSHOTS_ (baremetal)
- [X] 5.2 _Host Networking_ [6/6]
  - [X] 'controller'[3/3]
    - [X] Management NIC : 10.0.0.11/24, gw:10.0.0.1
    - [X] Provider NIC  : via netplan, set dhcp4 & dhcp6 false, do not set static ip
    - [X] Edit etc/hosts: see pg 20 in pdf version of install docs
  - [X] 'compute1'[3/3]
    - [X] Management NIC : 10.0.0.31/24, gw:10.0.0.1
    - [X] Provider NIC : via netplan, set dhcp4 & dhcp6 false, do not set static ip
    - [X] Edit etc/hosts: see pg 22 in pdf version of install docs
  - [X] 'block1'[2/2]
    - [X] Management NIC : 10.0.0.41/24, gw:10.0.0.1
    - [X] Edit etc/hosts: see pg 23 in pdf version of install docs
  - [X] Confirm Connectivity: [7/7]
    - [X] from @controller, ping -c 4 docs.openstack.org == PASS
    - [X] from @controller, ping -c 4 compute1
    - [X] from @compute, ping -c 4 openstack.org
    - [X] from @compute, ping -c 4 controller
    - [X] repeat ping from @block1
    - [X] repeat ping from @object1
    - [X] repeat ping from @object2
  - [X] 'object1'
  - [X] 'object2'
- [X] 5.3 _NTP_ [3/3]
  - [X] Controller Node
  - [X] Other Nodes
  - [X] Verify
- [ ] _SNAPSHOTS_ (post-NTP, pre-package install)
- [X] 5.4 _Package Archives_ (repeat on all nodes) [1/1]
  - [X] Enable Repository / Ubuntu 20.04 / Yoga
- [X] _SQL_ (on controller) [3/3]
  - [X] Install Package
  - [X] Create & Edit config file
  - [X] Finalize
- [X] _Message Queue_ (on controller) [3/3]
  - [X] Install Package
  - [X] Add openstack user
  - [X] Permit config, write, & read access for user
- [X] _Memcached_ (on controller) [3/3]
  - [X] Install package (python3 version)
  - [X] edit config file
  - [X] Finalize (start service)
- [X] _Etcd_ (on controller) [2/2]
  - [X] Install Package
  - [X] edit config files
------
** Environment Install Footnotes 
+ From [[https://docs.openstack.org/install-guide/environment-networking.html]] :
#+BEGIN_QUOTE
The example architectures assume use of the following networks:
_Management on 10.0.0.0/24 with gateway 10.0.0.1_
This network requires a gateway to provide Internet access to all nodes for administrative purposes such as package installation, security updates, DNS, and NTP.
_Provider on 203.0.113.0/24 with gateway 203.0.113.1_
This network requires a gateway to provide Internet access to instances in your OpenStack environment.
You can modify these ranges and gateways to work with your particular network infrastructure.
Network interface names vary by distribution. Traditionally, interfaces use eth followed by a sequential number. To cover all variations, this guide refers to the first interface as the interface with the lowest number and the second interface as the interface with the highest number.
 Note
Ubuntu has changed the network interface naming concept. Refer Changing Network Interfaces name Ubuntu 16.04.
Unless you intend to use the exact configuration provided in this example architecture, you must modify the networks in this procedure to match your environment. Each node must resolve the other nodes by name in addition to IP address. _For example, the controller name must resolve to 10.0.0.11, the IP address of the management interface on the controller node._
#+END_QUOTE

+ <2023-03-30 Thu> NOTE: Installation Guide / Controller Node / Configure Network Interfaces...
  Documentation refers to old legacy method of network config using networkinterfaces.  Since Ubuntu 20.04 use /etc/netplan, not /etc/network/interfaces
#+NAME:Ubuntu Netplan Config
#+begin_src shell -n
sgc@ops-cntrl-01:~$ cat /etc/netplan/00-installer-config.yaml
# This is the network config written by 'subiquity'
network:
  ethernets:
    ens160:
      addresses:
        - 10.0.0.11/24
      gateway4: 10.0.0.1
      nameservers:
              addresses: [8.8.8.8, 1.1.1.1]
    ens192:
      dhcp4: false
      dhcp6: false
  version: 2
#+end_src
- Be sure that both /etc/hosts and /etc/hostname have the corect names.
- If all is working, should be able to SSH to host (i.e. 10.0.0.11) and when logged in host name will display correctly in terminal

+ <2023-03-30 Thu> NOTE: Archive Enablement:
  using OpenStack Yoga for Ubuntu 20.04 LTS (server 64bit)
  - add-apt-repository cloud-archive:yoga

------
------
* Project(s) Installation Journal

** TODO Projects(s) Install Task List / YOGA / UBUNTU
*** TODO Keystone: Install [6/6]
- REF: Projects Install Doc / Yoga / Keystone ([[https:docs.openstack.org/keystone/yoga/doc-keystone.pdf][link]])
- TARGET(S): controller
- USER: root (either 'sudo -i'  or 'su -')
- [X] *Initialize SQL*
#+NAME: Database Prep
#+begin_src sh -n
  # mysql
  MariaDB > CREATE DATABASE keystone;
  MariaDB > GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'pwd123';
  MariaDB > GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'pwd123';  replace dbpass with password
#+end_src

- NOTE: A good test here would be to exit root (#), and as user ($) try to access the database.  If you get 1045 errors, that indicates an authentication problem and the rest of the process will fail until authentication is working.  When done testing from user, remember to return to root for remainder of process.  If the below does not produce a connection to SQL, stop and troubleshoot.
- [X] *Test SQL Connection*
  #+begin_src sh -n
    $ mysql -u keystone -p
    MariaDB [(none)]>
  #+end_src

- [X] *Instlal Kestone Package*
#+name: Install Keystone Package [2023-04-03 Mon] 
#+begin_src sh -n
  # apt install keystone
  # vi /etc/keystone/keystone.conf (make edits per docs)
  # su -s /bin/sh -c "keystone-manage db_sync" keystone
#+end_src
- [X] *Initialize Repositories*
#+name: Initialize Key Repositories
#+begin_src sh -n
  # keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
  # keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
#+end_src
- [X] *Bootstrap ID service*
#+name: Bootstrap the Identity Service [admin pwd = pwd123]
#+begin_src sh -n
  # keystone-manage bootstrap --bootstrap-password pwd123 --bootstrap-admin-url http://controller:5000/v3/ --bootstrap-internal-url http://controller:5000/v3/ --bootstrap-public-url http://controller:5000/v3/ --bootstrap-region-id RegionOne 
#+end_src
- [X] *Edit Env Variables*
#+name: Bootstrap Env Variables
#+begin_src sh -n
  $ export OS_USERNAME=admin
  $ export OS_PASSWORD=ADMIN_PASS
  $ export OS_PROJECT_NAME=admin
  $ export OS_USER_DOMAIN_NAME=Default
  $ export OS_PROJECT_DOMAIN_NAME=Default
  $ export OS_AUTH_URL=http://controller:5000/v3
  $ export OS_IDENTITY_API_VERSION=3
#+end_src

- NOTE: Before doing the above, do a '$ printenv' and look at the environment variables.  There should already be populated a number of OS_ (openstack) entries.  If not, it may mean that the bootstraping commands did not complete correctly.  This happened to me.  After backing up and going through the bootstrapping commands again I found 5 of the 7 above env variables already in print env.  After adding the missing two, the rest of the process ran correctly.

*** TODO Keystone: HW RESULTS [4/4]
- [X] *Confirm Token Assignment*

#+name: TOKEN
#+ATTR_LATEX: :options frame=single
#+begin_example sn -n
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field      | Value
         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| expires    | 2023-04-03T21:10:00+0000
         |
| id         | gAAAAABkKzKY1kcGmTmr2azLTezITAUGLjV7a_N_t90aZRQvr-lF7I0Oo3mq7sbeYBmKVEa_3rqiKuZipSpm_TMRKzObbF7yl_lup9-VkYmvl3_daPTAT5MDxrr_qHPqF0vl2TQMBZYA1we_-_RVnrUuHzPw9BR71TUXFiote79KFPSzxXkt7Es |
| project_id | af55244dfe134e73bb68d80af4842abb
         |
| user_id    | 483616691ea84ae3936b9cadd1725b4f
         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
#+end_example

- [X] *Confirm demo (myuser) and admin users are created*
#+name:Create demo (myuser) and admin users
#+begin_example sh -n
sgc@controller:~$ openstack --os-auth-url http://controller:5000/v3 \
> --os-project-domain-name Default --os-user-domain-name Default \
> --os-project-name admin --os-username admin token issue
Password:
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field      | Value
         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| expires    | 2023-04-03T21:10:00+0000
         |
| id         | gAAAAABkKzKY1kcGmTmr2azLTezITAUGLjV7a_N_t90aZRQvr-lF7I0Oo3mq7sbeYBmKVEa_3rqiKuZipSpm_TMRKzObbF7yl_lup9-VkYmvl3_daPTAT5MDxrr_qHPqF0vl2TQMBZYA1we_-_RVnrUuHzPw9BR71TUXFiote79KFPSzxXkt7Es |
| project_id | af55244dfe134e73bb68d80af4842abb
         |
| user_id    | 483616691ea84ae3936b9cadd1725b4f
         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

sgc@controller:~$ openstack --os-auth-url http://controller:5000/v3 \
> --os-project-domain-name Default --os-user-domain-name Default \
> --os-project-name myproject --os-username myuser token issue
Password:
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Field      | Value
         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| expires    | 2023-04-03T21:14:47+0000
         |
| id         | gAAAAABkKzO3m0xEVmt5KXdpNRarHdbsQKu_R3Kvl_vsl_Qj4zLRd1sKbFmj6hLiImTpjfF2drCIqH0-NRIUfPKERlTJcj9k-1-Lw8W5b94eeDWs-m77VlXJLcpIjGiSehIM4TDhYqYuWmu4r_zs_OH5v3CllqhdtpV9HuMOku5jID5Ytf4YiPM |
| project_id | 9e2b1df7e13e4e90a1dfe3d12e96374e
         |
| user_id    | 2e7b44d196454070a7f6da6d66b61b5a
         |
+------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
#+end_example

- [X] *Confirm user list can be retrieved*
#+name: RETRIEVE USER LIST
#+begin_example sh -n
MariaDB [keystone]> SELECT * FROM user
    -> ;
+----------------------------------+-------+---------+--------------------+---------------------+----------------+-----------+
| id                               | extra | enabled | default_project_id | created_at          | last_active_at | domain_id |
+----------------------------------+-------+---------+--------------------+---------------------+----------------+-----------+
| 2e7b44d196454070a7f6da6d66b61b5a | {}    |       1 | NULL               | 2023-04-03 20:05:06 | NULL           | default   |
| 483616691ea84ae3936b9cadd1725b4f | {}    |       1 | NULL               | 2023-04-03 19:55:11 | NULL           | default   |
+----------------------------------+-------+---------+--------------------+---------------------+----------------+-----------+
2 rows in set (0.000 sec)
#+end_example

- [X] *Confirm role list can be retrieved*
#+name:RETRIEVE ROLE LIST
#+begin_example sh -n
MariaDB [keystone]> SELECT * FROM role;
+----------------------------------+--------+-------+-----------+-------------+
| id                               | name   | extra | domain_id | description |
+----------------------------------+--------+-------+-----------+-------------+
| 0b25f16d85fa4fcdbbf560c8776b009c | admin  | {}    | <<null>>  | NULL        |
| 27490b2ef72343719edaad6ef2d3baa6 | myrole | {}    | <<null>>  | NULL        |
| 53a2975840ca44d1876980c8267a1c1b | member | {}    | <<null>>  | NULL        |
| 78965140ce3941b7806c809bdabe86e8 | reader | {}    | <<null>>  | NULL        |
+----------------------------------+--------+-------+-----------+-------------+
4 rows in set (0.001 sec)

MariaDB [keystone]>
#+end_example
------
*** TODO Glance: Install (on controller) [10/10]
- [X] *DB Configuration*
  #+begin_src sh -n
    # mysql
    MariaDB [(none)] CREATE DATABASE glance;
  #+end_src

- [X] Source the admin credentials (./os-scripts/) ~$ . admin-openrc~
- [X] Create the =glance= user
    #+begin_src sh -n
$ ~/os-scripts$ openstack user create --domain default --password-prompt glance
User Password:
Repeat User Password:
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| domain_id           | default                          |
| enabled             | True                             |
| id                  | 5e99d020af48473da06c73a4ce96e50a |
| name                | glance                           |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+
#+end_src
- [X] Add the admin role to the glance user and service project
  #+begin_src sh -n
  $ openstack role add --project service --user glance admin
  #+end_src
- [X] Create the glance service entry
  #+begin_src sh -n
  $ openstack service create --name glance \
  $ --description "OpenStack Image" image
  #+end_src
- [X] Create the Image Service API
  #+begin_src sh -n
  $ openstack endpoint create --region RegionOne \
  $ image public http://controller:9292
  #+end_src
- [X] Install glance packages
  #+begin_src sh -n
  # apt install glance
  #+end_src
- [X] Make edits to =/etc/glance/glance-api.conf=
  + Online documentation is does not match conf file installed via steps above.
  + [oslo_limit] section was missing but may not matter, not doing quota's
  + =use_keystone_quotas= is now =use_keystone_limits=, but no impact, left default false.
- [X] Populate Image service database and restart service
  #+begin_src sh -n
    # su -s /bin/sh -c "glance-manage db_sync" glance
    # service glance-api restart
  #+end_src
- [X] Verify Operation (see doc [[https://docs.openstack.org/glance/yoga/install/verify.html][link]])
*** TODO Glance: HW RESULTS [2/2]
- [X] HW Glance 1: Import Cirros OS Image
#+begin_example sh -n
  $ glance image-create --name "cirros" \
> --file cirros-0.4.0-x86_64-disk.img \
> --disk-format qcow2 --container-format bare \
> --visibility=public
+------------------+----------------------------------------------------------------------------------+
| Property         | Value                                                                            |
+------------------+----------------------------------------------------------------------------------+
| checksum         | 443b7623e27ecf03dc9e01ee93f67afe                                                 |
| container_format | bare                                                                             |
| created_at       | 2023-04-04T01:24:37Z                                                             |
| disk_format      | qcow2                                                                            |
| id               | 25c894f6-fe98-4da3-a8d9-89ef27508d46                                             |
| min_disk         | 0                                                                                |
| min_ram          | 0                                                                                |
| name             | cirros                                                                           |
| os_hash_algo     | sha512                                                                           |
| os_hash_value    | 6513f21e44aa3da349f248188a44bc304a3653a04122d8fb4535423c8e1d14cd6a153f735bb0982e |
|                  | 2161b5b5186106570c17a9e58b64dd39390617cd5a350f78                                 |
| os_hidden        | False                                                                            |
| owner            | af55244dfe134e73bb68d80af4842abb                                                 |
| protected        | False                                                                            |
| size             | 12716032                                                                         |
| status           | active                                                                           |
| tags             | []                                                                               |
| updated_at       | 2023-04-04T01:24:37Z                                                             |
| virtual_size     | 46137344                                                                         |
| visibility       | public                                                                           |
+------------------+----------------------------------------------------------------------------------+
sgc@controller:~$
#+end_example
- [X] HW Glance 2: Retrieve Image List
#+begin_example sh -n
sgc@controller:~$ glance image-list
+--------------------------------------+--------+
| ID                                   | Name   |
+--------------------------------------+--------+
| 25c894f6-fe98-4da3-a8d9-89ef27508d46 | cirros |
+--------------------------------------+--------+
sgc@controller:~$
#+end_example
------
*** TODO Placement: Install
*** TODO Placement: HW RESULTS
------
*** TODO Neutron: Install
*** TODO Neutron: HW RESULTS
------
*** TODO Horizon: Install
*** TODO Horizon: HW RESULTS
------
*** TODO Cinder: Install
*** TODO Cinder: HW RESUlts
------
 
